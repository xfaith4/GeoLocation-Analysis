<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNSS Data Analysis - GeoLocation Visualization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <header>
        <div class="container">
            <div class="theme-toggle">
                <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle dark mode">
                    <span id="theme-icon">üåô</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>
            <h1>üõ∞Ô∏è GNSS Data Analysis Platform</h1>
            <p>High-Precision Positioning Visualization & Analysis</p>
        </div>
    </header>

    <main class="container">
        <!-- Statistics Dashboard -->
        <section class="stats-dashboard">
            <h2>üìä Summary Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Total Sentences</div>
                    <div class="stat-value" id="total-sentences">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üõ∞Ô∏è</div>
                    <div class="stat-label">Avg Satellites</div>
                    <div class="stat-value" id="avg-satellites">-</div>
                    <div class="stat-detail" id="satellite-range">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìç</div>
                    <div class="stat-label">Primary Fix Type</div>
                    <div class="stat-value" id="fix-quality">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìè</div>
                    <div class="stat-label">Avg HDOP</div>
                    <div class="stat-value" id="avg-hdop">-</div>
                    <div class="stat-detail" id="hdop-range">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚õ∞Ô∏è</div>
                    <div class="stat-label">Altitude Range</div>
                    <div class="stat-value" id="altitude-range">-</div>
                    <div class="stat-detail" id="altitude-avg">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì°</div>
                    <div class="stat-label">Signal Quality</div>
                    <div class="stat-value" id="signal-quality">-</div>
                    <div class="stat-detail">High-Precision Fixes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìê</div>
                    <div class="stat-label">Position Spread</div>
                    <div class="stat-value" id="position-spread">-</div>
                    <div class="stat-detail">Coverage Area</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">Data Points</div>
                    <div class="stat-value" id="data-points">-</div>
                    <div class="stat-detail" id="fix-breakdown">-</div>
                </div>
            </div>
        </section>

        <!-- Fix Type Distribution -->
        <section class="fix-distribution-section">
            <h2>üéØ Fix Type Distribution</h2>
            <div class="fix-distribution-container">
                <div class="fix-bars" id="fix-bars">
                    <p class="loading">Loading fix type data...</p>
                </div>
                <div class="fix-legend" id="fix-legend">
                    <p><strong>Understanding Fix Types:</strong></p>
                    <ul>
                        <li><strong>RTK Fixed:</strong> Centimeter-level accuracy (~1-2 cm)</li>
                        <li><strong>RTK Float:</strong> Decimeter-level accuracy (~10-50 cm)</li>
                        <li><strong>DGPS Fix:</strong> Meter-level accuracy (~1-5 m)</li>
                        <li><strong>GPS Fix:</strong> Standard accuracy (~3-10 m)</li>
                        <li><strong>No Fix:</strong> Position unavailable</li>
                    </ul>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px;"><em>Note: Actual accuracy depends on environmental conditions, receiver quality, and satellite geometry.</em></p>
                </div>
            </div>
        </section>

        <!-- Position Corrections Panel -->
        <section class="corrections-section">
            <h2>üéØ Position Corrections & Analysis</h2>
            <p class="section-description">Apply advanced correction algorithms to improve positioning accuracy by analyzing multiple readings. Corrections help eliminate systematic errors and reduce position scatter.</p>
            
            <div class="corrections-container">
                <!-- Correction Controls -->
                <div class="correction-controls">
                    <h3>Correction Settings</h3>
                    
                    <div class="control-group">
                        <label for="correction-method">Correction Method:</label>
                        <select id="correction-method" class="correction-select">
                            <option value="mean">Simple Average (Mean)</option>
                            <option value="median">Median Filter</option>
                            <option value="weighted_average" selected>Weighted Average (Quality-Based)</option>
                        </select>
                        <p class="control-hint">Weighted average considers fix quality, satellite count, and HDOP for best results</p>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="weight-by-quality" checked>
                            Weight by Signal Quality
                        </label>
                        <p class="control-hint">Prioritize high-quality fixes (RTK) over lower quality positions</p>
                    </div>
                    
                    <button id="calculate-corrections-btn" class="btn btn-primary">Calculate Corrections</button>
                    <button id="apply-corrections-btn" class="btn btn-secondary" disabled>Apply Corrections to Data</button>
                </div>
                
                <!-- Correction Results -->
                <div class="correction-results" id="correction-results" style="display: none;">
                    <h3>Correction Results</h3>
                    
                    <div class="correction-stats">
                        <div class="correction-stat-card">
                            <div class="correction-stat-label">Corrected Position</div>
                            <div class="correction-stat-value">
                                <div id="corrected-lat">-</div>
                                <div id="corrected-lon">-</div>
                                <div id="corrected-alt">-</div>
                            </div>
                        </div>
                        
                        <div class="correction-stat-card">
                            <div class="correction-stat-label">Mean Correction</div>
                            <div class="correction-stat-value" id="mean-correction">-</div>
                            <div class="correction-stat-detail">Average distance adjusted</div>
                        </div>
                        
                        <div class="correction-stat-card">
                            <div class="correction-stat-label">Max Correction</div>
                            <div class="correction-stat-value" id="max-correction">-</div>
                            <div class="correction-stat-detail">Largest individual adjustment</div>
                        </div>
                        
                        <div class="correction-stat-card">
                            <div class="correction-stat-label">Position Spread</div>
                            <div class="correction-stat-value" id="spread-before">-</div>
                            <div class="correction-stat-detail">Data scatter before correction</div>
                        </div>
                    </div>
                    
                    <div class="correction-explanation">
                        <h4>How Corrections Work</h4>
                        <p id="correction-method-explanation">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Visualization -->
        <section class="map-section">
            <h2>Position Visualization</h2>
            <div id="map"></div>
            <div class="map-info">
                <p><strong>Map Legend:</strong></p>
                <ul>
                    <li><span class="marker-dot rtk-fixed"></span> RTK Fixed (Best)</li>
                    <li><span class="marker-dot rtk-float"></span> RTK Float (Good)</li>
                    <li><span class="marker-dot gps-fix"></span> GPS Fix (Standard)</li>
                    <li><span class="marker-dot no-fix"></span> No Fix (Poor)</li>
                </ul>
            </div>
        </section>

        <!-- Data Tables -->
        <section class="data-section">
            <h2>GNSS Data Details</h2>
            
            <div class="table-controls">
                <button id="toggle-gga" class="btn btn-primary active">GGA Data</button>
                <button id="toggle-rmc" class="btn btn-secondary">RMC Data</button>
                <button id="toggle-gsa" class="btn btn-secondary">GSA Data</button>
            </div>

            <!-- GGA Table -->
            <div id="gga-table-container" class="table-container">
                <h3>GGA - GPS Fix Data</h3>
                <table id="gga-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Altitude (m)</th>
                            <th>Fix Quality</th>
                            <th>Satellites</th>
                            <th>HDOP</th>
                        </tr>
                    </thead>
                    <tbody id="gga-tbody">
                        <tr><td colspan="7" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- RMC Table -->
            <div id="rmc-table-container" class="table-container" style="display: none;">
                <h3>RMC - Recommended Minimum Data</h3>
                <table id="rmc-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Speed (knots)</th>
                            <th>Course (¬∞)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="rmc-tbody">
                        <tr><td colspan="6" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- GSA Table -->
            <div id="gsa-table-container" class="table-container" style="display: none;">
                <h3>GSA - DOP and Active Satellites</h3>
                <table id="gsa-table">
                    <thead>
                        <tr>
                            <th>Mode</th>
                            <th>Fix Type</th>
                            <th>PDOP</th>
                            <th>HDOP</th>
                            <th>VDOP</th>
                            <th>Satellites Used</th>
                        </tr>
                    </thead>
                    <tbody id="gsa-tbody">
                        <tr><td colspan="6" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- File Upload Section -->
        <section class="upload-section">
            <h2>Upload GNSS Log File</h2>
            <div class="upload-container">
                <input type="file" id="file-input" accept=".nmea,.txt,.log" />
                <button id="upload-btn" class="btn btn-primary">Upload & Analyze</button>
                <div id="upload-status"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 GeoLocation Analysis | GNSS Data Visualization Platform</p>
            <p>Supporting RTK, SBAS, PPP, and Multi-Constellation GNSS</p>
        </div>
    </footer>

    <!-- Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
